
# Server block for reverse proxy with ModSecurity protection
server {
    listen 8080;
    server_name _;

    # ModSecurity is automatically enabled by the base image
    # The OWASP CRS rules are already loaded

    # Disable ModSecurity for /page-one (intentionally vulnerable for demonstration)
    location /page-one {
        modsecurity off;

        # Standard Nginx reverse proxy headers
        # Strip port from Host header to avoid :8080 in redirects
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Always use https since Traefik terminates TLS
        proxy_set_header X-Forwarded-Proto https;
        # Always use standard HTTPS port for redirects
        proxy_set_header X-Forwarded-Port 443;
        # Tell Spring Boot to use these headers
        proxy_set_header X-Forwarded-Host $host;

        # Proxy the request to the Spring Boot upstream
        proxy_pass ${BACKEND};

        # Disable default proxy_redirect behavior
        proxy_redirect off;
        # Rewrite any Location headers that include :8080 to remove the port
        proxy_redirect ~^https?://([^:/]+):8080/(.*)$ https://$1/$2;
        proxy_redirect ~^http://([^:/]+)/(.*)$ https://$1/$2;

        # Buffering configuration
        proxy_buffers 16 64k;
        proxy_buffer_size 128k;
        proxy_read_timeout 90;
    }

    location / {

        # Standard Nginx reverse proxy headers
        # Strip port from Host header to avoid :8080 in redirects
        proxy_set_header Host $host;
        # Pass the real client IP address for logging and ModSecurity analysis
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Always use https since Traefik terminates TLS
        proxy_set_header X-Forwarded-Proto https;
        # Always use standard HTTPS port for redirects
        proxy_set_header X-Forwarded-Port 443;
        # Tell Spring Boot to use these headers
        proxy_set_header X-Forwarded-Host $host;

        # Proxy the request to the Spring Boot upstream
        proxy_pass ${BACKEND};

        # Disable default proxy_redirect behavior
        proxy_redirect off;
        # Rewrite any Location headers that include :8080 to remove the port
        proxy_redirect ~^https?://([^:/]+):8080/(.*)$ https://$1/$2;
        proxy_redirect ~^http://([^:/]+)/(.*)$ https://$1/$2;

        # Buffering configuration (adjust if needed for large uploads/downloads)
        proxy_buffers 16 64k;
        proxy_buffer_size 128k;
        proxy_read_timeout 90;
    }
}
