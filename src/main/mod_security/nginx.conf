
# Map to handle X-Forwarded-Proto with fallback to https
map $http_x_forwarded_proto $forwarded_proto {
    default https;
    "~.+" $http_x_forwarded_proto;
}

# Server block for reverse proxy with ModSecurity protection
server {
    listen 8080;
    server_name _;

    # ModSecurity is automatically enabled by the base image
    # The OWASP CRS rules are already loaded

    # Disable ModSecurity for /page-one (intentionally vulnerable for demonstration)
    location /page-one {
        modsecurity off;

        # Standard Nginx reverse proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $forwarded_proto;
        proxy_set_header X-Forwarded-Port 443;

        # Proxy the request to the Spring Boot upstream
        proxy_pass ${BACKEND};

        # Buffering configuration
        proxy_buffers 16 64k;
        proxy_buffer_size 128k;
        proxy_read_timeout 90;
    }

    location / {

        # Standard Nginx reverse proxy headers
        proxy_set_header Host $host;
        # Pass the real client IP address for logging and ModSecurity analysis
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Use https as protocol (all external traffic comes through Traefik with HTTPS)
        proxy_set_header X-Forwarded-Proto $forwarded_proto;
        # Set standard HTTPS port
        proxy_set_header X-Forwarded-Port 443;

        # Proxy the request to the Spring Boot upstream
        proxy_pass ${BACKEND};

        # Buffering configuration (adjust if needed for large uploads/downloads)
        proxy_buffers 16 64k;
        proxy_buffer_size 128k;
        proxy_read_timeout 90;
    }
}
