# Upstream configuration for Spring Boot application
upstream spring_boot_app {
    server ${PROXY_UPSTREAM_HOST} max_fails=3 fail_timeout=60s;
}

# Server block for reverse proxy with ModSecurity protection
server {
    listen 80;
    server_name _;

    # ModSecurity is automatically enabled by the base image
    # The OWASP CRS rules are already loaded

    location / {
        # Standard Nginx reverse proxy headers
        proxy_set_header Host $host;
        # Pass the real client IP address for logging and ModSecurity analysis
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Proxy the request to the Spring Boot upstream
        proxy_pass http://spring_boot_app;

        # Buffering configuration (adjust if needed for large uploads/downloads)
        proxy_buffers 16 64k;
        proxy_buffer_size 128k;
        proxy_read_timeout 90;
    }

    # Optional: Disable ModSecurity for specific health checks or static assets
    # location /health {
    #     modsecurity off;
    #     proxy_pass http://spring_boot_app;
    # }
}
