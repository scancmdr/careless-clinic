
# Server block for reverse proxy with ModSecurity protection, v1.0.26
# Fixed: Use clean X-Forwarded-For instead of appending
server {
    listen 8080;
    server_name _;
    modsecurity off;

    # ModSecurity is automatically enabled by the base image
    # The OWASP CRS rules are already loaded



    location / {
        modsecurity on;

        # Ignore all incoming X-Forwarded headers from Traefik
        # and set our own values explicitly
        proxy_pass_header Server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto "https";
        proxy_set_header X-Forwarded-Port "443";
        proxy_set_header X-Forwarded-Host $host;

        # Proxy the request to the Spring Boot upstream
        proxy_pass ${BACKEND};

        # Rewrite Location headers - catch all patterns
        proxy_redirect ~^https?://[^/]+:8080(.*)$ $1;
        proxy_redirect ~^http://(.*)$ https://$1;
        proxy_redirect default;

        # Buffering configuration (adjust if needed for large uploads/downloads)
        proxy_buffers 16 64k;
        proxy_buffer_size 128k;
        proxy_read_timeout 90;
    }

    # Disable ModSecurity for /page-one (intentionally vulnerable for demonstration)
    location /page-one {


        # Ignore all incoming X-Forwarded headers from Traefik
        # and set our own values explicitly
        proxy_pass_header Server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto "https";
        proxy_set_header X-Forwarded-Port "443";
        proxy_set_header X-Forwarded-Host $host;

        # Proxy the request to the Spring Boot upstream
        proxy_pass ${BACKEND};

        # Rewrite Location headers - catch all patterns
        proxy_redirect ~^https?://[^/]+:8080(.*)$ $1;
        proxy_redirect ~^http://(.*)$ https://$1;
        proxy_redirect default;

        # Buffering configuration
        proxy_buffers 16 64k;
        proxy_buffer_size 128k;
        proxy_read_timeout 90;

        modsecurity_rules '
          SecRuleEngine On
          SecRequestBodyAccess On
          SecDebugLog /tmp/modsec_debug.log
          SecDebugLogLevel 9
          SecRuleRemoveById 10
        ';
    }
}
